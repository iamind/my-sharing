# リスクサインインアラートシステム詳細設計書

## 2. 機能設計

### 2.1 機能一覧

| 項番 | 機能名 | 概要 |
|------|--------|------|
| 2.1.1 | リソースグループ管理 | アラートシステム用のリソースグループを作成・管理 |
| 2.1.2 | アクショングループ管理 | アラート通知先となるアクショングループを設定 |
| 2.1.3 | メール通知先管理 | 複数のメールアドレスを動的に設定・管理 |
| 2.1.4 | アラートルール作成 | Log Analyticsクエリベースのアラートルールを作成 |
| 2.1.5 | リスクサインイン検出 | 指定されたクエリに基づきリスクサインインを検出 |
| 2.1.6 | 定期監視実行 | 1時間ごとにクエリを実行し条件を評価 |
| 2.1.7 | アラート通知 | 条件に合致した場合、登録メールアドレスに通知 |
| 2.1.8 | リソース廃止管理 | 廃止フラグによるリソースの論理削除 |

### 2.2 機能詳細仕様

#### 2.2.1 リソースグループ管理
- **処理内容**: Azure上にリソースグループを作成
- **入力**: リソースグループ名、タイプ
- **出力**: リソースグループID
- **制約**: タイプが"廃止"の場合は作成しない
- **場所**: 固定値 "japaneast"

#### 2.2.2 アクショングループ管理
- **処理内容**: Azure Monitorアクショングループの作成・設定
- **入力**: 名前、リソースグループ名、短縮名、タイプ、メール受信者リスト
- **出力**: アクショングループID
- **制約**: 
  - タイプが"廃止"の場合は作成しない
  - 短縮名は12文字以内

#### 2.2.3 メール通知先管理
- **処理内容**: アクショングループ内のメール受信者を動的設定
- **入力**: メールアドレスリスト（mailaddress, type）
- **処理**: 
  - typeが"廃止"でないメールアドレスのみ登録
  - dynamic blockで複数アドレスを処理

#### 2.2.4 アラートルール作成
- **処理内容**: スケジュールクエリルールアラートの作成
- **入力**: 
  - 基本情報: 名前、リソースグループ、タイプ
  - 監視設定: スコープ、クエリ
  - アクション: アクショングループID
- **キー生成**: `format("%s-%s", item.table, item.account)`
- **制約**: タイプが"廃止"の場合は作成しない

#### 2.2.5〜2.2.7 監視・検出・通知機能
- **評価頻度**: PT1H（1時間）
- **集計期間**: PT1H（1時間）
- **アラート条件**: 
  - 演算子: GreaterThan
  - 閾値: 0
  - 集計方法: Count
- **重要度**: 3（情報レベル）
- **自動緩和**: 有効

#### 2.2.8 リソース廃止管理
- **処理内容**: typeフラグによるリソースの論理削除
- **対象リソース**: 
  - リソースグループ
  - アクショングループ
  - アラートルール
  - メール通知先
- **動作**: type == "廃止"の場合、countを0に設定してリソースを作成しない

## 3. データ設計

### 3.1 データ構造

#### 3.1.1 入力データ構造（var.guest）
```hcl
var.guest = {
  risksignin_actiongroup = {
    name                = string  # アクショングループ名
    resource_group_name = string  # リソースグループ名
    short_name         = string  # 短縮名（12文字以内）
    type               = string  # "作成" or "廃止"
  }
  
  risksignin_notification = [
    {
      mailaddress = string  # メールアドレス
      type        = string  # "作成" or "廃止"
    }
  ]
  
  risksignin_alertrule = [
    {
      table          = string  # 監視対象テーブル名
      account        = string  # アカウント識別子
      name           = string  # アラートルール名
      resource_group = string  # リソースグループ名
      scope          = string  # Log AnalyticsワークスペースID
      query          = string  # KQLクエリ
      type           = string  # "作成" or "廃止"
    }
  ]
}
```

#### 3.1.2 モジュール間インターフェース
```hcl
# resource_groupモジュール出力
output "id" {
  value = azurerm_resource_group.example[0].id
}

# action_groupモジュール出力
output "action_group_id" {
  value = azurerm_monitor_action_group.example[0].id
}
```

### 3.2 データフロー図

```
[Azure DevOps Pipeline]
        |
        | (1) folderName, 実行フラグ
        ↓
[download_param.yml]
        |
        | (2) パラメータファイル（var.guest）
        ↓
[terraform/main.tf]
        |
        | (3) var.guest.risksignin_actiongroup
        ↓
[resource_groupモジュール] → (4) リソースグループ作成
        |
        | (5) var.guest.risksignin_notification
        ↓
[action_groupモジュール] → (6) アクショングループ作成
        |                       ↓
        |                  (7) action_group_id
        |
        | (8) var.guest.risksignin_alertrule
        ↓
[scheduled_query_rules_alertモジュール] → (9) アラートルール作成
        |
        ↓
[Azure Monitor] → (10) 定期的なクエリ実行
        |
        | (11) アラート条件合致
        ↓
[メール通知] → 登録アドレスへ送信
```

## 4. プログラム設計

### 4.1 ファイル構造

```
├── az11.yml                                    # Azure DevOpsパイプライン定義
│   ├── 実行条件判定
│   ├── 依存ジョブ管理（19ジョブ）
│   └── Terraformタスク呼び出し
│
└── terraform/
    ├── entralog_alert/
    │   └── main.tf                            # メイン設定ファイル
    │       ├── リソースグループモジュール呼び出し
    │       ├── アクショングループモジュール呼び出し
    │       └── アラートルールモジュール呼び出し（for_each）
    │
    └── modules/
        ├── resource_group/
        │   └── resource_group.tf              # リソースグループ作成
        │       └── azurerm_resource_group
        │
        ├── action_group/
        │   └── action_group.tf                # アクショングループ設定
        │       ├── azurerm_monitor_action_group
        │       └── dynamic email_receiver
        │
        └── scheduled_query_rules_alert/
            └── scheduled_query_rules_alert.tf # アラートルール設定
                └── azurerm_monitor_scheduled_query_rules_alert_v2
```

### 4.2 モジュール仕様

#### 4.2.1 resource_groupモジュール

| 項目 | 内容 |
|------|------|
| **ファイル** | modules/resource_group/resource_group.tf |
| **リソース** | azurerm_resource_group |
| **入力変数** | name (string), type (string) |
| **出力変数** | なし（将来的にはIDを出力すべき） |
| **条件処理** | count = var.type == "廃止" ? 0 : 1 |
| **固定値** | location = "japaneast" |

#### 4.2.2 action_groupモジュール

| 項目 | 内容 |
|------|------|
| **ファイル** | modules/action_group/action_group.tf |
| **リソース** | azurerm_monitor_action_group |
| **入力変数** | name, resource_group_name, short_name, type, email_receiver |
| **出力変数** | action_group_id |
| **条件処理** | count = var.type == "廃止" ? 0 : 1 |
| **動的処理** | dynamic "email_receiver" ブロックで複数メール設定 |
| **フィルタ** | email_receiver.type != "廃止" のみ処理 |

#### 4.2.3 scheduled_query_rules_alertモジュール

| 項目 | 内容 |
|------|------|
| **ファイル** | modules/scheduled_query_rules_alert/scheduled_query_rules_alert.tf |
| **リソース** | azurerm_monitor_scheduled_query_rules_alert_v2 |
| **入力変数** | name, resource_group_name, action_group_id, scope, query, type |
| **出力変数** | なし |
| **条件処理** | count = var.type == "廃止" ? 0 : 1 |
| **固定設定** | severity=3, evaluation_frequency="PT1H", window_duration="PT1H" |
| **アラート条件** | operator="GreaterThan", threshold=0, time_aggregation_method="Count" |

### 4.3 処理フロー

#### 4.3.1 全体処理フロー

```
開始
  │
  ├─[1] Azure DevOps Pipeline起動
  │     └─ riskysigninジョブ実行判定
  │
  ├─[2] 依存ジョブ完了確認（19ジョブ）
  │     └─ 全てSucceededまたはSkipped
  │
  ├─[3] 実行条件確認
  │     └─ Execute_AZ11_riskysignin == 'true'
  │
  ├─[4] パラメータ取得
  │     ├─ download_param.yml実行
  │     └─ var.guestデータ読み込み
  │
  ├─[5] Terraform実行
  │     ├─ terraform init
  │     ├─ terraform plan
  │     └─ terraform apply
  │
  └─[6] リソース作成完了
        └─ tfstateファイル保存
```

#### 4.3.2 Terraform詳細処理フロー

```
main.tf実行
  │
  ├─[1] プロバイダー設定
  │     └─ azurerm.subscriptionC
  │
  ├─[2] リソースグループ作成
  │     ├─ module.resource_group_alert呼び出し
  │     ├─ var.guest.risksignin_actiongroup参照
  │     └─ type != "廃止"の場合のみ作成
  │
  ├─[3] アクショングループ作成
  │     ├─ module.azurerm_monitor_action_group呼び出し
  │     ├─ depends_on: resource_group_alert
  │     └─ メール受信者動的設定
  │           └─ for each email in risksignin_notification
  │                 └─ if email.type != "廃止"
  │
  └─[4] アラートルール作成（for_each）
        ├─ var.guest.risksignin_alertruleをループ
        ├─ キー生成: "${table}-${account}"
        ├─ type != "廃止"のアイテムのみ処理
        └─ 各アラートルール作成
              ├─ Log Analyticsスコープ設定
              ├─ クエリ設定
              ├─ アクショングループ紐付け
              └─ 評価条件設定（1時間ごと）
```

---

## 不足情報メモ

以下の情報が提供されれば、より完全な詳細設計書となります：
- var.guestの実際の値例
- Log Analyticsクエリの具体例（リスクサインイン検出ロジック）
- download_param.ymlとterraform_tasks.ymlの内容
- プロバイダー設定（providers.tf）
- エラー処理とリトライロジック
